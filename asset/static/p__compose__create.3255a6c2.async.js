"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[1102],{24963:function(te,U,n){var F=n(67294),o=(0,F.createContext)({});U.Z=o},33208:function(te,U,n){n.r(U),n.d(U,{default:function(){return Ie}});var F=n(97857),o=n.n(F),z=n(64599),y=n.n(z),D=n(19632),N=n.n(D),R=n(15009),P=n.n(R),A=n(99289),b=n.n(A),I=n(5574),M=n.n(I),W=n(91058),H=n(12491),x=n(24963),C=n(90098),L=n(3393),V=n(79245),K=n(45742),m=n(91806),p=n(27496),j=n(33862),u=n(90078),je=n(97269),Me=n(2236),T=n(38345),Ce=n(52688),B=n(5966),Be=n(86615),le=n(97462),Ue=n(62370),ue=n(95213),se=n(95089),ie=n(82346),_e=n(28036),w=n(25409),be=n(63490),oe=n(42075),Te=n(66309),de=n(38925),Fe=n(92398),Re=n(91845),O=n(67294),Ae=n(96781),a=n(85893);function Ie(){var Q,J,X,q,ee,k=(0,O.useContext)(x.Z),G=k.loading,We=k.notice,Ne=k.message,He=k.lang,me=(0,ie.useNavigate)(),xe=(0,O.useState)([]),ce=M()(xe,2),pe=ce[0],Le=ce[1],Ke=(0,O.useRef)(),E=(0,O.useRef)(),Ze=(0,ie.useSearchParams)(),ve=M()(Ze,2),Se=ve[0],we=ve[1],$e=(0,O.useState)(),Ee=M()($e,2),e=Ee[0],Ve=Ee[1],ke=(0,O.useState)(!1),he=M()(ke,2),fe=he[0],ge=he[1],Y=(Q=Se.get("id"))!==null&&Q!==void 0?Q:"",Ge=(0,O.useContext)(Ae.Z),Pe=Ge.listTableRef,Ye=(0,O.useState)({yaml:"",yamlOverride:""}),Oe=M()(Ye,2),c=Oe[0],ae=Oe[1],Z=function(){var t=b()(P()().mark(function l(r){var i,s,_;return P()().wrap(function(v){for(;;)switch(v.prev=v.next){case 0:return ae(r),v.next=3,(0,C.xC)({yaml:[r.yaml,(i=r.yamlOverride)!==null&&i!==void 0?i:""],environment:(s=E.current)===null||s===void 0?void 0:s.getFieldValue("environment")});case 3:if(_=v.sent,!(!_||!_.data||!_.data.project)){v.next=7;break}return We.error(_.data.error),v.abrupt("return");case 7:_.data.project&&Le(Object.keys(_.data.project.services).map(function(f,ne){var g=_.data.project.services[f];return g.name=f,g}));case 8:case"end":return v.stop()}},l)}));return function(r){return t.apply(this,arguments)}}();return(0,O.useEffect)(function(){Y&&(G.show(),(0,C.Pn)({id:Y}).then(function(t){var l,r,i;if(t.data.detail.setting.type==""&&(t.data.detail.setting.type="text"),(l=E.current)===null||l===void 0||l.setFieldsValue({name:t.data.detail.name,title:t.data.detail.title,type:t.data.detail.setting.type,yaml:(r=t.data.yaml[0])!==null&&r!==void 0?r:"",yamlOverride:(i=t.data.yaml[1])!==null&&i!==void 0?i:"",environment:t.data.detail.setting.environment}),t.data.detail.setting.type=="remoteUrl"){var s;(s=E.current)===null||s===void 0||s.setFieldValue("remoteUrl",t.data.detail.setting.remoteUrl)}else if(t.data.detail.setting.type=="storagePath"){var _;(_=E.current)===null||_===void 0||_.setFieldValue("storagePath","/dpanel/compose/"+t.data.detail.setting.uri[0])}if(Ve(t.data),t.data.yaml){var h;Z({yaml:t.data.yaml[0],yamlOverride:(h=t.data.yaml[1])!==null&&h!==void 0?h:""})}}).catch(function(t){me("/compose/list")}).finally(function(){G.destroy()}))},[]),(0,O.useEffect)(function(){var t,l,r=[];c.yaml!=""&&c.yamlOverride==""||(e&&r.push.apply(r,N()(e.detail.setting.environment)),c.yaml!=""&&(0,V.m)(c.yaml).map(function(i){r.find(function(s){return s.name==i.name})||r.push(i)}),c.yamlOverride&&c.yamlOverride!=""&&(0,V.m)(c.yamlOverride).map(function(i){r.find(function(s){return s.name==i.name})||r.push(i)}),(t=E.current)===null||t===void 0||t.resetFields(["environment"]),(l=E.current)===null||l===void 0||l.setFieldValue("environment",r))},[c]),(0,a.jsx)(u._z,{header:{extra:[]},children:(0,a.jsx)(je.A,{submitter:{render:function(l,r){return(0,a.jsxs)(Me.S,{children:[(0,a.jsx)(_e.ZP,{onClick:function(){var s;(s=l.form)===null||s===void 0||s.setFieldValue("deployBackground",!0),l.submit()},children:"\u540E\u53F0\u90E8\u7F72"}),(0,a.jsx)("span",{children:r[1]},"submit")]})}},formRef:E,onFinishFailed:function(l){ge(!1)},onFinish:function(){var t=b()(P()().mark(function l(r){var i,s,_,h;return P()().wrap(function(f){for(;;)switch(f.prev=f.next){case 0:return _={type:r.type,name:r.name,title:r.title,environment:r.environment,remoteUrl:r.remoteUrl,yaml:r.yaml,yamlOverride:r.yamlOverride,deployBackground:(i=r.deployBackground)!==null&&i!==void 0?i:!1},Y&&(_.id=Y),f.next=4,(0,C.im)(_);case 4:return h=f.sent,(s=E.current)===null||s===void 0||s.resetFields(),r.deployBackground&&new Promise(function(){var ne=b()(P()().mark(function g(ye,ze){var S,De,re;return P()().wrap(function(d){for(;;)switch(d.prev=d.next){case 0:d.prev=0,S=y()(pe.map(function($){return $.image})),d.prev=2,S.s();case 4:if((De=S.n()).done){d.next=11;break}if(re=De.value,!re){d.next=9;break}return d.next=9,(0,L.Gb)({tag:re,type:"pull"});case 9:d.next=4;break;case 11:d.next=16;break;case 13:d.prev=13,d.t0=d.catch(2),S.e(d.t0);case 16:return d.prev=16,S.f(),d.finish(16);case 19:d.next=24;break;case 21:d.prev=21,d.t1=d.catch(0),ze(d.t1);case 24:return d.prev=24,d.next=27,(0,C.Oh)({id:h.data.id,pullImageUseDPanel:!0,environment:r.environment,deployServiceName:[],createPath:!0,removeOrphans:!0}).finally(function(){var $;!(($=Pe.current)===null||$===void 0)&&$.reloadAndRest&&Pe.current.reloadAndRest()});case 27:return d.finish(24);case 28:ye(!0);case 29:case"end":return d.stop()}},g,null,[[0,21,24,28],[2,13,16,19]])}));return function(g,ye){return ne.apply(this,arguments)}}()),me("/compose/list/"),f.abrupt("return",!0);case 9:case"end":return f.stop()}},l)}));return function(l){return t.apply(this,arguments)}}(),children:(0,a.jsx)(T.Z,{split:"vertical",children:(0,a.jsxs)(w.Z,{onResize:function(){},children:[(0,a.jsx)(w.Z.Panel,{resizable:!1,size:fe?"0%":"45%",children:(0,a.jsxs)(T.Z,{split:"horizontal",children:[(0,a.jsxs)(T.Z,{title:(0,a.jsx)(K.Z,{}),subTitle:"\u57FA\u7840\u4FE1\u606F",children:[(0,a.jsx)(Ce.Z,{label:"\u540E\u53F0\u90E8\u7F72",name:"deployBackground",hidden:!0}),(0,a.jsx)(B.Z,{label:"\u7AD9\u70B9\u540D\u79F0",name:"title",disabled:(e==null?void 0:e.detail.setting.type)=="outPath",fieldProps:{onChange:function(l){var r="";if(l.target.value&&!(e!=null&&e.detail)){var i,s=(0,Re.N9)(l.target.value.trim(),{toneType:"none",type:"array"});r=s.join(""),(i=E.current)===null||i===void 0||i.setFieldValue("name",r)}}}}),(0,a.jsx)(B.Z,{label:"\u7AD9\u70B9\u6807\u8BC6",name:"name",required:!0,rules:[{required:!0}],disabled:!!(e!=null&&e.detail),placeholder:"\u6807\u8BC6Compose\u521B\u5EFA\u7684\u5BB9\u5668\u7EC4\uFF0C\u53EA\u5141\u8BB8\u4E3A\u82F1\u6587\u6216\u662F\u6570\u5B57"}),(0,a.jsx)(Be.Z.Group,{label:"Yaml \u6765\u6E90",name:"type",initialValue:"text",fieldProps:{defaultValue:"text",onChange:function(){}},options:[{label:"yaml",value:"text",disabled:(e==null?void 0:e.detail)&&(e==null?void 0:e.detail.setting.type)!="text"},{label:"\u8FDC\u7A0B\u5730\u5740",value:"remoteUrl",disabled:(e==null?void 0:e.detail)&&(e==null||(J=e.detail)===null||J===void 0?void 0:J.setting.type)!="remoteUrl"},{label:"\u81EA\u52A8\u53D1\u73B0",value:"storagePath",disabled:(e==null?void 0:e.detail)&&(e==null||(X=e.detail)===null||X===void 0?void 0:X.setting.type)!="storagePath"},{label:"\u5E94\u7528\u5546\u5E97",value:"store",disabled:(e==null?void 0:e.detail)&&(e==null||(q=e.detail)===null||q===void 0?void 0:q.setting.type)!="store"},{label:"\u5916\u90E8\u4EFB\u52A1",value:"outPath",disabled:(e==null?void 0:e.detail)&&(e==null||(ee=e.detail)===null||ee===void 0?void 0:ee.setting.type)!="outPath"}]}),(0,a.jsx)(le.Z,{name:["type"],children:function(l){var r=l.type;if(r=="text")return(0,a.jsx)(H.Z,{title:"\u5BFC\u5165\u672C\u5730 compose \u6587\u4EF6",onImport:function(s){var _;return Z(o()(o()({},c),{yaml:s})),(_=E.current)===null||_===void 0||_.setFieldValue("yaml",s),!0},onLoad:function(s){if(s.indexOf("services:")<0)throw new Error("\u5BFC\u5165\u7684compose\u6587\u4EF6\u9519\u8BEF");return!0}});if(r=="remoteUrl")return(0,a.jsx)(B.Z,{label:"",required:!0,rules:[{required:!0}],name:"remoteUrl",placeholder:"\u8BF7\u8F93\u5165\u8FDC\u7A0B docker-compose.yaml \u94FE\u63A5",fieldProps:{onBlur:function(){var i=b()(P()().mark(function _(h){var v,f;return P()().wrap(function(g){for(;;)switch(g.prev=g.next){case 0:if(h.target.value){g.next=2;break}return g.abrupt("return");case 2:return G.show(),g.next=5,(0,C.MG)({uri:h.target.value});case 5:v=g.sent,G.destroy(),v&&v.data&&v.data.content&&(Z(o()(o()({},c),{yaml:v.data.content})),(f=E.current)===null||f===void 0||f.setFieldValue("yaml",v.data.content));case 8:case"end":return g.stop()}},_)}));function s(_){return i.apply(this,arguments)}return s}()}});if(r=="storagePath")return(0,a.jsx)(a.Fragment,{children:(0,a.jsx)(B.Z,{name:"storagePath",required:!0,readonly:!0,initialValue:e!=null&&e.detail?"".concat(e==null?void 0:e.detail.setting.uri[0]):"\u6302\u8F7D /dpanel/compose \u76EE\u5F55\u540E\uFF0C\u81EA\u52A8\u53D1\u73B0\u3002",rules:[{required:!0,message:"\u6302\u8F7D /dpanel/compose \u76EE\u5F55\u540E\uFF0C\u81EA\u52A8\u53D1\u73B0\u3002"}]})});if(r=="store")return(0,a.jsx)(a.Fragment,{children:(0,a.jsx)(B.Z,{readonly:!0,name:"store",required:!0,initialValue:e!=null&&e.detail?"".concat(e==null?void 0:e.detail.setting.store):"\u8BF7\u5148\u6DFB\u52A0\u5E94\u7528\u5546\u5E97\u540E\uFF0C\u5728\u5E94\u7528\u5546\u5E97\u91CC\u5B8C\u6210\u5B89\u88C5",rules:[{required:!0,message:"\u8BF7\u5148\u6DFB\u52A0\u5E94\u7528\u5546\u5E97\u540E\uFF0C\u5728\u5E94\u7528\u5546\u5E97\u91CC\u5B8C\u6210\u5B89\u88C5"}]})});if(r=="outPath")return(0,a.jsx)(a.Fragment,{children:(0,a.jsx)(B.Z,{name:"outPath",required:!0,readonly:!0,initialValue:(e==null?void 0:e.detail)&&"".concat(e==null?void 0:e.detail.setting.uri[0]),rules:[{required:!0,message:"\u5916\u90E8\u4EFB\u52A1\u53EA\u53EF\u7F16\u8F91 yaml "}]})})}})]}),(0,a.jsx)(T.Z,{title:(0,a.jsx)(m.Z,{}),subTitle:"\u670D\u52A1\u5217\u8868",children:(0,a.jsx)(be.Z,{dataSource:pe,rowKey:"name",pagination:!1,columns:[{title:"\u540D\u79F0",dataIndex:"name"},{title:"\u955C\u50CF",dataIndex:"image"},{title:"\u7AEF\u53E3",dataIndex:"ports",render:function(l,r,i){return r.ports&&r.ports.map(function(s,_){return(0,a.jsx)(oe.Z,{size:"large",wrap:!0,children:(0,a.jsxs)(Te.Z,{color:"#2db7f5",icon:s.published?(0,a.jsx)(p.Z,{}):"",style:{marginBottom:5},children:[s.published," : ",s.target]})},"space".concat(_))})}},{title:"\u4F9D\u8D56",dataIndex:"dependsOn",width:150,render:function(l,r,i){if(r.depends_on)return(0,a.jsx)(oe.Z,{wrap:!0,children:Object.keys(r.depends_on).map(function(s){var _=s;return r.external_links&&r.external_links.map(function(h){h.indexOf(":"+s)>-1&&(_=h)}),_})})}}]})}),(0,a.jsxs)(T.Z,{title:(0,a.jsx)(j.Z,{}),subTitle:"\u73AF\u5883\u53D8\u91CF",children:[(0,a.jsx)(le.Z,{name:["environment"],children:function(l){var r=l.environment;if(!r||r.length==0)return(0,a.jsx)(de.Z,{message:(0,a.jsxs)(a.Fragment,{children:["\u5728 compose.yaml \u4E2D\u58F0\u660E\u73AF\u5883\u53D8\u91CF\uFF0C\u4F8B\u5982\uFF1A","${DB_NAME}"," ",(0,a.jsx)("br",{}),"\u5728\u90E8\u7F72\u65F6\u53EF\u6839\u636E\u60C5\u51B5\u8FDB\u884C\u91CD\u65B0\u8D4B\u503C\u3002"]})})}}),(0,a.jsx)(W.Z,{name:"environment",showDisableName:!0,showInDrawer:!0,showCardGhost:!0,ref:Ke})]})]})}),(0,a.jsx)(w.Z.Panel,{children:(0,a.jsxs)(T.Z,{children:[(0,a.jsx)(Ue.Z,{name:"yamlOverride",hidden:!0}),(0,a.jsx)(B.Z,{name:"yaml",hidden:!0}),(0,a.jsx)(Fe.Z,{tabBarExtraContent:(0,a.jsx)(_e.ZP,{type:"link",onClick:function(){ge(!fe)},children:"\u5168\u5C4F"}),items:[{label:"Yaml \u6587\u4EF6",key:"yaml",children:(0,a.jsx)(a.Fragment,{children:(0,a.jsx)(se.ZP,{theme:"dark",minHeight:"550px",onChange:function(l){ae(o()(o()({},c),{yaml:l}))},onBlur:function(){var l;(l=E.current)===null||l===void 0||l.setFieldValue("yaml",c.yaml),Z(c)},value:c.yaml,extensions:[ue.RI.yaml()]})})},{label:"\u8986\u76D6 Yaml \u6587\u4EF6",key:"yamlOverride",children:(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(de.Z,{style:{marginBottom:20},message:(0,a.jsxs)(a.Fragment,{children:["\u8986\u76D6\u6587\u4EF6\uFF0C\u5141\u8BB8\u4F60\u5728\u4E0D\u6539\u52A8\u539F\u59CB Yaml \u6587\u4EF6\u7684\u60C5\u51B5\u4E0B\uFF0C\u8986\u76D6\u539F\u59CB\u6587\u4EF6\u4E2D\u7684\u4E00\u4E9B\u53C2\u6570\u914D\u7F6E\u3002",(0,a.jsx)("a",{href:"https://dpanel.cc/#/zh-cn/manual/compose/override",target:"_blank",children:"\u5982\u4F55\u914D\u7F6E\uFF1F"})]})}),(0,a.jsx)(se.ZP,{theme:"dark",minHeight:"550px",onChange:function(l,r){ae(o()(o()({},c),{yamlOverride:l}))},value:c.yamlOverride,extensions:[ue.RI.yaml()],onBlur:function(){var l;console.log("dddd"),(l=E.current)===null||l===void 0||l.setFieldValue("yamlOverride",c.yamlOverride),Z(c)}})]})}]})]})})]})})},"create")})}},3393:function(te,U,n){n.d(U,{Gb:function(){return P},Pn:function(){return M},Rb:function(){return H},YU:function(){return N},ZQ:function(){return V},_U:function(){return b},cd:function(){return C}});var F=n(15009),o=n.n(F),z=n(99289),y=n.n(z),D=n(82346);function N(m){return R.apply(this,arguments)}function R(){return R=y()(o()().mark(function m(p){return o()().wrap(function(u){for(;;)switch(u.prev=u.next){case 0:return u.abrupt("return",(0,D.request)("/api/app/image/get-detail",{method:"POST",data:p}));case 1:case"end":return u.stop()}},m)})),R.apply(this,arguments)}function P(m){return A.apply(this,arguments)}function A(){return A=y()(o()().mark(function m(p){return o()().wrap(function(u){for(;;)switch(u.prev=u.next){case 0:return u.abrupt("return",(0,D.request)("/api/app/image/tag-remote",{method:"POST",data:p}));case 1:case"end":return u.stop()}},m)})),A.apply(this,arguments)}function b(m){return I.apply(this,arguments)}function I(){return I=y()(o()().mark(function m(p){return o()().wrap(function(u){for(;;)switch(u.prev=u.next){case 0:return u.abrupt("return",(0,D.request)("/api/app/image/tag-add",{method:"POST",data:p}));case 1:case"end":return u.stop()}},m)})),I.apply(this,arguments)}function M(m){return W.apply(this,arguments)}function W(){return W=y()(o()().mark(function m(p){return o()().wrap(function(u){for(;;)switch(u.prev=u.next){case 0:return u.abrupt("return",(0,D.request)("/api/app/image/tag-delete",{method:"POST",data:p}));case 1:case"end":return u.stop()}},m)})),W.apply(this,arguments)}function H(m){return x.apply(this,arguments)}function x(){return x=y()(o()().mark(function m(p){return o()().wrap(function(u){for(;;)switch(u.prev=u.next){case 0:return u.abrupt("return",(0,D.request)("/api/app/image/export",{method:"POST",data:p,responseType:"blob"}));case 1:case"end":return u.stop()}},m)})),x.apply(this,arguments)}function C(m){return L.apply(this,arguments)}function L(){return L=y()(o()().mark(function m(p){return o()().wrap(function(u){for(;;)switch(u.prev=u.next){case 0:return u.abrupt("return",(0,D.request)("/api/pro/image/get-remote-tag",{method:"POST",data:p}));case 1:case"end":return u.stop()}},m)})),L.apply(this,arguments)}function V(m){return K.apply(this,arguments)}function K(){return K=y()(o()().mark(function m(p){return o()().wrap(function(u){for(;;)switch(u.prev=u.next){case 0:return u.abrupt("return",(0,D.request)("/api/app/image/check-upgrade",{method:"POST",data:p}));case 1:case"end":return u.stop()}},m)})),K.apply(this,arguments)}}}]);
