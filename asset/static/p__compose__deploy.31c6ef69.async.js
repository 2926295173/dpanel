"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[7667],{9740:function(rt,K,r){r.r(K),r.d(K,{default:function(){return ze}});var he=r(19632),Fe=r.n(he),pe=r(15009),f=r.n(pe),ge=r(99289),A=r.n(ge),xe=r(5574),$=r.n(xe),y=r(80821),Y=r(54964),F=r(90098),J=r(43425),W=r(74842),X=r(48689),je=r(33160),ye=r(87784),Ze=r(30159),Ce=r(86548),k=r(89035),De=r(45742),Pe=r(90078),g=r(38345),w=r(97269),Z=r(62370),P=r(82346),q=r(28036),I=r(42075),b=r(25593),C=r(84567),z=r(96074),Se=r(63490),Ee=r(83062),_=r(92398),v=r(67294),Re=r(99861),Ae=r(95089),$e=r(95213),Le=r(24963),ee=r(91058),Be=r(12320),ut=r(89629),Ve=r(78267),e=r(85893),O=new Be.Terminal(Y.a),H=new Ve.FitAddon;function Ie(S){var L=(0,P.useModel)("subscriber");return L.addDataHandler("compose:log:"+S.id,function(N){O.write(N.data)}),(0,v.useEffect)(function(){return window.addEventListener("resize",function(){H.fit()}),O.options.fontSize=12,O.loadAddon(H),O.open(document.getElementById("terminal-log")),H.fit(),O.clear(),function(){L.progress.close("compose:log:"+S.id)}},[S.id]),(0,e.jsx)("div",{id:"terminal-log",style:{width:"100%",height:"500px"}})}var Oe=r(37413),Ne=r(87662),Te=r(94359),Ge=r(79245),be=r(78451),Ue=r(57716),we=r(78272);function ze(){var S,L,N,M=(0,v.useContext)(Le.Z),te=M.loading,He=M.lang,at=M.notice,T=(0,P.useParams)(),ne=(0,P.useNavigate)(),Me=(0,v.useState)(),re=$()(Me,2),t=re[0],Qe=re[1],x=(0,v.useRef)(),Ke=(0,v.useState)(0),ue=$()(Ke,2),j=ue[0],D=ue[1],Ye=(0,v.useState)("default"),ae=$()(Ye,2),Je=ae[0],E=ae[1],h=(0,v.useRef)(),ie=(0,P.useModel)("subscriber"),We=(0,v.useState)(""),le=$()(We,2),Xe=le[0],ke=le[1],U=(0,v.useRef)(),B=(0,v.useRef)(),Q=(0,v.useRef)(),qe=(0,v.useState)(!1),se=$()(qe,2),_e=se[0],oe=se[1],et=(0,P.useSearchParams)(),ce=$()(et,2),tt=ce[0],nt=ce[1];ie.addDataHandler("compose:"+T.id,function(a){var u;(u=x.current)===null||u===void 0||u.write(a.data)});var de=(0,v.useRef)(),ve=(0,v.useRef)(),me=function(){var a=A()(f()().mark(function u(n){var i,l,o;return f()().wrap(function(d){for(;;)switch(d.prev=d.next){case 0:if(E("deploy"),(i=x.current)===null||i===void 0||i.clear(),!n.pullImageUseDPanel){d.next=6;break}return d.next=5,(l=Q.current)===null||l===void 0?void 0:l.start();case 5:(o=Q.current)===null||o===void 0||o.finish();case 6:return d.next=8,(0,F.Oh)(n);case 8:D(j+1);case 9:case"end":return d.stop()}},u)}));return function(n){return a.apply(this,arguments)}}();return(0,v.useEffect)(function(){return te.show(),oe(!1),(0,F.Pn)({id:T.id}).then(function(){var a=A()(f()().mark(function u(n){var i,l,o,c,d,m;return f()().wrap(function(G){for(;;)switch(G.prev=G.next){case 0:i=n.data.detail,i.setting.status&&i.setting.status.indexOf("running")>-1&&(i.isRunning=!0),i.setting.status&&i.setting.status.indexOf("paused")>-1&&(i.isPaused=!0),i.setting.status&&i.setting.status.indexOf("exited")>-1&&(i.isExited=!0),i.setting.status&&i.setting.status=="waiting"?i.isDeploy=!1:i.isDeploy=!0,i.setting.status&&i.setting.status.indexOf("created")>-1&&(i.isCreated=!0,i.isDeploy=!1),n.data.project&&(i.imageList=Fe()(new Set(Object.keys(n.data.project.services).map(function(s){var p;return(p=n.data.project.services[s].image)!==null&&p!==void 0?p:""})))),l=n.data.project,(!n.data.containerList||n.data.containerList.length==0)&&l&&l.services&&(n.data.containerList=Object.keys(l.services).map(function(s){return{name:"",service:s,publishers:l.services[s].ports?l.services[s].ports.map(function(p){var R;return{url:"",targetPort:p.target,publishedPort:parseInt(p.published),protocol:(R=p.protocol)!==null&&R!==void 0?R:""}}):[],state:"waiting",status:""}})),n.data.containerList&&((0,Ne.EH)().then(function(s){ke(s.data.ip)}),i.containerList=n.data.containerList,(o=h.current)===null||o===void 0||o.setFieldValue("deployServiceName",n.data.detail.setting.deployServiceName)),i.yamlList=n.data.yaml,Qe(i),l!=null&&l.services&&Object.keys(l.services).map(function(s){var p=[];if(l.services&&l.services[s]&&(l.services[s].environment&&Object.keys(l.services[s].environment).map(function(fe){l.services[s].environment&&p.push({name:fe,value:l.services[s].environment[fe]})}),p.length!=0)){var R;(R=h.current)===null||R===void 0||R.setFieldValue(["environmentService",s],p)}}),n.data.detail.setting.environment?(c=h.current)===null||c===void 0||c.setFieldValue("environment",n.data.detail.setting.environment):(m=(0,Ge.m)(n.data.yaml[0]),(d=h.current)===null||d===void 0||d.setFieldValue("environment",m)),i.isDeploy&&(0,F.VN)({id:T.id});case 15:case"end":return G.stop()}},u)}));return function(u){return a.apply(this,arguments)}}()).catch(function(a){ne("/compose/list")}).finally(A()(f()().mark(function a(){return f()().wrap(function(n){for(;;)switch(n.prev=n.next){case 0:te.destroy();case 1:case"end":return n.stop()}},a)}))),function(){ie.progress.close("compose:log:"+T.id)}},[j]),(0,v.useEffect)(function(){if(tt.get("op")=="deploy"&&t){var a={id:t.id||t.name,pullImageUseDPanel:!0,environment:t.setting.environment,deployServiceName:[],createPath:!0,removeOrphans:!0};me(a),D(j+1),nt("")}},[t]),(0,e.jsxs)(Pe._z,{header:{extra:[(0,e.jsx)(P.Link,{to:"/compose/create",reloadDocument:location.search.length>0,children:(0,e.jsx)(q.ZP,{type:"primary",children:"\u521B\u5EFA\u4EFB\u52A1"},"createCompose")},"create")]},children:[(0,e.jsx)(Ue.Z,{ref:de}),(0,e.jsx)(we.Z,{ref:ve}),(0,e.jsxs)(g.Z,{direction:"column",ghost:!0,gutter:[10,10],children:[(0,e.jsx)(g.Z,{title:(0,e.jsx)(J.Z,{}),subTitle:"\u64CD\u4F5C - "+(t==null?void 0:t.name),bordered:!0,extra:(0,e.jsx)(e.Fragment,{children:t&&t.imageList&&t.imageList.length>0&&(0,e.jsx)(Re.Z,{ref:Q,image:t.imageList})}),headerBordered:!0,children:t&&(0,e.jsxs)(I.Z,{wrap:!0,children:[(0,e.jsx)(y.Z,{icon:(0,e.jsx)(W.Z,{}),type:"primary",confirm:(0,e.jsxs)(I.Z,{style:{width:300},direction:"vertical",children:[(0,e.jsx)(b.Z.Text,{children:"\u91CD\u65B0\u521B\u5EFA\u8BE5\u4EFB\u52A1\u4E0B\u7684\u5BB9\u5668\uFF1F"}),(0,e.jsxs)(w.A,{name:"createForm",formRef:B,layout:"inline",submitter:!1,children:[(0,e.jsx)(Z.Z,{initialValue:!1,name:"pullImageUseCommand",valuePropName:"checked",children:(0,e.jsx)(C.Z,{children:"\u4F7F\u7528\u547D\u4EE4\u62C9\u53D6\u955C\u50CF\uFF08\u9700\u914D\u7F6E\u547D\u4EE4\u4EE3\u7406\uFF09\uFF1F"})}),(0,e.jsx)(Z.Z,{initialValue:!0,name:"pullImageUseDPanel",valuePropName:"checked",children:(0,e.jsx)(C.Z,{defaultChecked:!0,children:"\u4F7F\u7528\u9762\u677F\u62C9\u53D6\u955C\u50CF\uFF08\u9700\u914D\u7F6E\u4ED3\u5E93\u52A0\u901F\uFF09\uFF1F"})}),(0,e.jsx)(Z.Z,{initialValue:!0,name:"createPath",valuePropName:"checked",children:(0,e.jsx)(C.Z,{defaultChecked:!0,children:"\u521B\u5EFA\u6302\u8F7D\u76EE\u5F55\uFF08\u4EC5\u9762\u677F\u975E\u5BB9\u5668\u90E8\u7F72\u751F\u6548\uFF09\uFF1F"})}),(0,e.jsx)(Z.Z,{initialValue:!0,name:"removeOrphans",valuePropName:"checked",children:(0,e.jsx)(C.Z,{defaultChecked:!0,children:"\u6E05\u9664\u5DF2\u91CD\u547D\u540D\u6216\u662F\u88AB\u5220\u9664\u7684\u670D\u52A1\uFF1F"})})]})]}),action:A()(f()().mark(function a(){var u,n,i,l,o,c,d,m,V;return f()().wrap(function(s){for(;;)switch(s.prev=s.next){case 0:if(m={id:t.id||t.name},(u=B.current)!==null&&u!==void 0&&u.getFieldValue&&B.current.getFieldValue("pullImageUseDPanel")&&(m.pullImageUseDPanel=!0),m.environment=(n=h.current)===null||n===void 0?void 0:n.getFieldValue("environment"),m.deployServiceName=(i=h.current)===null||i===void 0?void 0:i.getFieldValue("deployServiceName"),m.createPath=(l=(o=B.current)===null||o===void 0?void 0:o.getFieldValue("createPath"))!==null&&l!==void 0?l:!0,m.removeOrphans=(c=(d=B.current)===null||d===void 0?void 0:d.getFieldValue("removeOrphans"))!==null&&c!==void 0?c:!0,!(t!=null&&t.isDeploy)){s.next=10;break}if(!((V=B.current)!==null&&V!==void 0&&V.getFieldValue("pullImageUseCommand"))){s.next=10;break}return s.next=10,(0,F.GG)({id:t.id||t.name,op:"pull"});case 10:me(m);case 11:case"end":return s.stop()}},a)})),children:t.isDeploy?"\u66F4\u65B0":"\u542F\u52A8"},"create"),(t.isDeploy||t.isCreated)&&(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(y.Z,{action:function(){var u;return(u=x.current)===null||u===void 0||u.clear(),E("destory"),(0,F.mg)({id:t.id||t.name,deleteImage:!1,deleteData:!1,deleteVolume:!1,deletePath:!1})},onSuccess:function(){D(j+1)},type:"primary",danger:!0,confirm:"notification.confirm.title",icon:(0,e.jsx)(X.Z,{}),children:"\u5220\u9664\u5BB9\u5668"}),(0,e.jsx)(z.Z,{type:"vertical"})]}),t.isDeploy&&(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(y.Z,{icon:(0,e.jsx)(je.Z,{}),action:A()(f()().mark(function a(){return f()().wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return E("crtl"),n.next=3,(0,F.GG)({id:t.id||t.name,op:"restart"});case 3:D(j+1);case 4:case"end":return n.stop()}},a)})),children:"\u91CD\u542F"},"restart"),(0,e.jsx)(y.Z,{action:function(){var u;return(u=x.current)===null||u===void 0||u.clear(),E("crtl"),(0,F.GG)({id:t.id||t.name,op:"stop"})},icon:(0,e.jsx)(ye.Z,{}),disabled:t.isExited,onSuccess:function(){D(j+1)},children:"\u505C\u6B62"}),t.isPaused&&(0,e.jsx)(y.Z,{action:function(){var u;return E("crtl"),(u=x.current)===null||u===void 0||u.clear(),(0,F.GG)({id:t.id||t.name,op:"unpause"})},onSuccess:function(){D(j+1)},icon:(0,e.jsx)(W.Z,{}),children:"\u6062\u590D"}),!t.isPaused&&(0,e.jsx)(y.Z,{action:function(){var u;return E("crtl"),(u=x.current)===null||u===void 0||u.clear(),(0,F.GG)({id:t.id||t.name,op:"pause"})},onSuccess:function(){D(j+1)},icon:(0,e.jsx)(Ze.Z,{}),disabled:!t.isRunning,children:"\u6682\u505C"})]}),(0,e.jsx)(z.Z,{type:"vertical"}),(0,e.jsx)(P.Link,{to:"/compose/create?id="+(t.id||t.name),children:(0,e.jsx)(q.ZP,{icon:(0,e.jsx)(Ce.Z,{}),children:"\u7F16\u8F91\u4EFB\u52A1"})}),t.isDeploy&&t.id>0&&(0,e.jsx)(y.Z,{type:"primary",action:A()(f()().mark(function a(){var u,n,i,l,o,c,d,m,V;return f()().wrap(function(s){for(;;)switch(s.prev=s.next){case 0:return(u=x.current)===null||u===void 0||u.clear(),E("destory"),s.next=4,(0,F.mg)({id:(n=t==null?void 0:t.id)!==null&&n!==void 0?n:0,deleteImage:(i=(l=U.current)===null||l===void 0?void 0:l.getFieldValue("deleteImage"))!==null&&i!==void 0?i:!1,deleteData:!0,deleteVolume:(o=(c=U.current)===null||c===void 0?void 0:c.getFieldValue("deleteVolume"))!==null&&o!==void 0?o:!1,deletePath:(d=(m=U.current)===null||m===void 0?void 0:m.getFieldValue("deletePath"))!==null&&d!==void 0?d:!1});case 4:V=s.sent;case 5:case"end":return s.stop()}},a)})),danger:!0,onSuccess:function(){ne("/compose/list")},confirm:(0,e.jsxs)(I.Z,{style:{width:240},direction:"vertical",children:[(0,e.jsx)(b.Z.Text,{children:"\u4F1A\u540C\u65F6\u5220\u9664\u5BB9\u5668\u53CA\u90E8\u7F72\u76F8\u5173\u6570\u636E\uFF0C\u672A\u52FE\u9009\u5220\u9664 compose \u6587\u4EF6\u65F6 yaml \u6587\u4EF6\u5C06\u4F1A\u4FDD\u7559\uFF0C\u786E\u8BA4\u5417\uFF1F"}),(0,e.jsxs)(w.A,{formRef:U,layout:"inline",submitter:!1,children:[(0,e.jsx)(Z.Z,{initialValue:!1,name:"deleteImage",valuePropName:"checked",children:(0,e.jsx)(C.Z,{children:"\u5220\u9664\u955C\u50CF\uFF1F"})}),(0,e.jsx)(Z.Z,{initialValue:!1,name:"deleteVolume",valuePropName:"checked",children:(0,e.jsx)(C.Z,{children:"\u5220\u9664\u5B58\u50A8\u5377\uFF1F"})}),(0,e.jsx)(Z.Z,{initialValue:!1,name:"deletePath",valuePropName:"checked",children:(0,e.jsx)(C.Z,{children:"\u5220\u9664 Compose \u6587\u4EF6\u548C\u4EFB\u52A1\u76EE\u5F55\uFF1F"})})]})]}),children:"\u5220\u9664\u4EFB\u52A1"})]})},"operator"),(0,e.jsxs)(g.Z,{split:"vertical",children:[(0,e.jsxs)(g.Z,{colSpan:"45%",direction:"column",split:"horizontal",title:"\u542F\u52A8\u914D\u7F6E",subTitle:"\u7F16\u8F91\u540E\u53EA\u5F71\u54CD\u672C\u6B21\u90E8\u7F72",extra:[t&&!t.isDeploy&&(0,e.jsx)(C.Z,{onChange:function(u){oe(u.target.checked)},children:"\u81EA\u5B9A\u4E49\u90E8\u7F72\u5BB9\u5668\u670D\u52A1\uFF1F"},"selectService")],children:[Je!="default"&&(0,e.jsx)(g.Z,{title:(0,e.jsx)(k.Z,{}),subTitle:"\u63A7\u5236\u53F0",extra:(0,e.jsx)(I.Z,{children:(0,e.jsx)(y.Z,{action:function(){var u;return(u=x.current)===null||u===void 0||u.clear(),(0,F.U_)({})},icon:(0,e.jsx)(X.Z,{}),danger:!0,onSuccess:function(){D(j+1)},children:"\u4E2D\u6B62\u6267\u884C"},"kill")}),children:(0,e.jsx)(Y.Z,{height:"300px",style:{fontSize:12},ref:x})}),t&&(0,e.jsx)(g.Z,{children:(0,e.jsx)(Se.Z,{scroll:{x:"max-content"},rowKey:"service",pagination:!1,columns:[{title:"\u5BB9\u5668\u540D\u79F0",dataIndex:"name",width:200,render:function(u,n,i){return(0,e.jsx)(Ee.Z,{title:n.service,children:(0,e.jsx)(be.Z,{content:n.name?n.name:n.service})})}},{title:"\u7AEF\u53E3",render:function(u,n,i){var l=[],o=[];return n.publishers&&n.publishers.map(function(c){c.publishedPort?l.push({PrivatePort:c.targetPort,Type:c.protocol,IP:c.url,PublicPort:c.publishedPort}):c.publishedPort&&o.push({PrivatePort:c.targetPort,Type:c.protocol,IP:c.url,PublicPort:c.publishedPort})}),(0,e.jsx)(Oe.Z,{publicPort:l,privatePort:o,domain:[],serverIp:Xe})}},{title:"\u72B6\u6001",render:function(u,n,i){return(0,e.jsx)(Te.Z,{status:n.state,message:{content:He("container.status.".concat(n.state)),placement:"top",showInTag:!0}},n.name)}},{title:"\u64CD\u4F5C",fixed:"right",render:function(u,n,i){return(0,e.jsxs)(I.Z,{split:(0,e.jsx)(z.Z,{type:"vertical"}),children:[(0,e.jsx)(b.Z.Link,{onClick:function(){var o;(o=ve.current)===null||o===void 0||o.show(n.name)},children:(0,e.jsx)(J.Z,{})},"container"),n.state=="running"&&(0,e.jsx)(b.Z.Link,{onClick:function(){var o;(o=de.current)===null||o===void 0||o.show(n.name)},children:(0,e.jsx)(k.Z,{})},"console")]})}}],dataSource:t.containerList,rowSelection:_e&&t.containerList?{defaultSelectedRowKeys:t.containerList.map(function(a){return a.service}),onChange:function(u,n,i){var l;(l=h.current)===null||l===void 0||l.setFieldValue("deployServiceName",u)}}:void 0})}),(0,e.jsxs)(w.A,{formRef:h,submitter:!1,children:[(0,e.jsx)(Z.Z,{name:"deployServiceName",hidden:!0}),!(t!=null&&t.isDeploy)&&(0,e.jsx)(g.Z,{title:"\u73AF\u5883\u53D8\u91CF",subTitle:"\u9762\u677F\u751F\u6210 .dpanel.env \u6587\u4EF6\uFF0C\u540C\u65F6\u4F1A\u52A0\u8F7D .env",children:(0,e.jsx)(ee.Z,{showCardGhost:!0,name:"environment",showDisableName:!0,showInDrawer:!0,requireValue:!0})}),!(t!=null&&t.isDeploy)&&(0,e.jsx)(g.Z,{title:"\u670D\u52A1\u73AF\u5883\u53D8\u91CF",tooltip:"\u4FEE\u6539\u670D\u52A1\u4E2D\u7684\u73AF\u5883\u53D8\u91CF\u65F6\uFF0C\u8BF7\u5728 yaml \u4E2D\u5C06\u503C\u5148\u6620\u5C04\u6210\u81EA\u5B9A\u4E49\u7684\u53D8\u91CF\u540D",children:(0,e.jsx)(_.Z,{indicator:{align:"center"},items:h&&h.current&&((S=h.current)===null||S===void 0?void 0:S.getFieldValue("environmentService"))&&Object.keys((L=h.current)===null||L===void 0?void 0:L.getFieldValue("environmentService")).map(function(a){return{label:a,key:a,children:(0,e.jsx)(ee.Z,{showCardGhost:!0,name:["environmentService",a],showDisableName:!0,showDisableValue:!0,showInDrawer:!0,requireValue:!0})}})})})]})]}),t&&!t.isDeploy&&(0,e.jsx)(g.Z,{colSpan:"55%",children:(0,e.jsx)(_.Z,{items:t.yamlList&&t.yamlList.map(function(a,u){var n=[{label:"Yaml \u6587\u4EF6",key:"yaml"},{label:"\u8986\u76D6 Yaml \u6587\u4EF6",key:"yamlOverride"}];return{label:n[u].label,key:n[u].key,disabled:a=="",children:(0,e.jsx)(e.Fragment,{children:(0,e.jsx)(Ae.ZP,{theme:"dark",minHeight:"550px",value:a,readOnly:!0,extensions:[$e.RI.yaml()]})})}})})}),t&&t.isDeploy&&(0,e.jsx)(g.Z,{title:(0,e.jsx)(De.Z,{}),subTitle:"\u65E5\u5FD7",colSpan:"55%",children:(0,e.jsx)(Ie,{id:(N=T.id)!==null&&N!==void 0?N:""})})]})]})]})}}}]);
