"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[1102],{24963:function(ne,O,t){var b=t(67294),o=(0,b.createContext)({});O.Z=o},96781:function(ne,O,t){var b=t(67294),o=(0,b.createContext)({});O.Z=o},84466:function(ne,O,t){t.r(O),t.d(O,{default:function(){return Ye}});var b=t(97857),o=t.n(b),ae=t(64599),x=t.n(ae),E=t(19632),ee=t.n(E),w=t(15009),y=t.n(w),z=t(99289),R=t.n(z),G=t(5574),Z=t.n(G),Y=t(91058),ue=t(12491),K=t(24963),D=t(90098),N=t(3393),re=t(79245),H=t(45742),c=t(91806),g=t(27496),B=t(33862),s=t(90078),me=t(97269),Se=t(2236),A=t(38345),Ue=t(52688),T=t(5966),Ie=t(86615),ce=t(97462),ve=t(62370),pe=t(95213),fe=t(95089),he=t(82346),le=t(28036),ie=t(25409),Ae=t(63490),ge=t(42075),Ve=t(66309),ye=t(38925),Me=t(92398),Le=t(91845),F=t(67294),We=t(96781),we=t(85060),ze=t(86738),e=t(85893),Ge=(0,F.forwardRef)(function(S,k){(0,F.useImperativeHandle)(k,function(){return{}});var U=(0,F.useRef)(),Q=(0,F.useState)(!1),V=Z()(Q,2),J=V[0],M=V[1];return(0,e.jsx)(e.Fragment,{children:(0,e.jsx)(ze.Z,{icon:!1,title:!1,description:(0,e.jsx)(me.A,{name:"importRemote",layout:"horizontal",submitter:!1,formRef:U,children:(0,e.jsx)(T.Z,{width:"lg",label:"Url",name:"url",placeholder:"https:// or http://"})}),onConfirm:R()(y()().mark(function L(){var j,I,te;return y()().wrap(function($){for(;;)switch($.prev=$.next){case 0:if(I=(j=U.current)===null||j===void 0?void 0:j.getFieldValue("url"),I){$.next=3;break}return $.abrupt("return");case 3:return M(!0),$.next=6,(0,D.MG)({uri:I});case 6:te=$.sent,M(!1),S.onFinish&&S.onFinish(te.data.content,I);case 9:case"end":return $.stop()}},L)})),children:(0,e.jsx)(le.ZP,{loading:J,icon:(0,e.jsx)(we.Z,{}),block:!0,onClick:function(){var j;(j=U.current)===null||j===void 0||j.resetFields()},children:S.title})})})}),Fe=Ge;function Ye(){var S,k,U,Q,V,J,M,L,j=(0,F.useContext)(K.Z),I=j.loading,te=j.notice,je=j.message,$=j.lang,Ce=(0,he.useNavigate)(),Ke=(0,F.useState)([]),xe=Z()(Ke,2),Ee=xe[0],Ne=xe[1],He=(0,F.useRef)(),v=(0,F.useRef)(),ke=(0,he.useSearchParams)(),Pe=Z()(ke,2),Qe=Pe[0],nr=Pe[1],Je=(0,F.useState)(),Oe=Z()(Je,2),r=Oe[0],Xe=Oe[1],qe=(0,F.useState)(!1),Re=Z()(qe,2),Ze=Re[0],Be=Re[1],X=(S=Qe.get("id"))!==null&&S!==void 0?S:"",_e=(0,F.useContext)(We.Z),$e=_e.listTableRef,er=(0,F.useState)({yaml:"",yamlOverride:""}),be=Z()(er,2),P=be[0],se=be[1],W=function(){var i=R()(y()().mark(function a(n){var d,l,u;return y()().wrap(function(h){for(;;)switch(h.prev=h.next){case 0:return rr(n),se(n),h.next=4,(0,D.xC)({id:X,yaml:[n.yaml,(d=n.yamlOverride)!==null&&d!==void 0?d:""],environment:(l=v.current)===null||l===void 0?void 0:l.getFieldValue("environment")});case 4:if(u=h.sent,!(!u||!u.data||!u.data.project)){h.next=8;break}return te.error(u.data.error),h.abrupt("return");case 8:u.data.project&&Ne(Object.keys(u.data.project.services).map(function(f,oe){var C=u.data.project.services[f];return C.name=f,C}));case 9:case"end":return h.stop()}},a)}));return function(n){return i.apply(this,arguments)}}(),rr=function(a){var n,d,l,u=[];a.yaml==""&&a.yamlOverride==""||(r&&r.detail.setting.environment&&u.push.apply(u,ee()(r.detail.setting.environment)),(n=v.current)!==null&&n!==void 0&&n.getFieldValue("environment")&&u.push.apply(u,ee()(v.current.getFieldValue("environment"))),a.yaml!=""&&(0,re.m)(a.yaml).map(function(p){u.find(function(h){return h.name==p.name})||u.push(p)}),a.yamlOverride&&a.yamlOverride!=""&&(0,re.m)(a.yamlOverride).map(function(p){u.find(function(h){return h.name==p.name})||u.push(p)}),(d=v.current)===null||d===void 0||d.resetFields(["environment"]),(l=v.current)===null||l===void 0||l.setFieldValue("environment",u))};return(0,F.useEffect)(function(){X&&(I.show(),(0,D.Pn)({id:X}).then(function(i){var a,n,d;if(i.data.detail.setting.type==""&&(i.data.detail.setting.type="text"),(a=v.current)===null||a===void 0||a.setFieldsValue({name:i.data.detail.name,title:i.data.detail.title,type:i.data.detail.setting.type,yaml:(n=i.data.yaml[0])!==null&&n!==void 0?n:"",yamlOverride:(d=i.data.yaml[1])!==null&&d!==void 0?d:"",environment:i.data.detail.setting.environment}),i.data.detail.setting.type=="remoteUrl"){var l;(l=v.current)===null||l===void 0||l.setFieldValue("remoteUrl",i.data.detail.setting.remoteUrl)}else if(i.data.detail.setting.type=="storagePath"){var u;(u=v.current)===null||u===void 0||u.setFieldValue("storagePath","/dpanel/compose/"+i.data.detail.setting.uri[0])}Xe(i.data)}).catch(function(i){Ce("/compose/list")}).finally(function(){I.destroy()}))},[]),(0,F.useEffect)(function(){var i;r&&r.detail&&W({yaml:r.yaml[0],yamlOverride:(i=r.yaml[1])!==null&&i!==void 0?i:""})},[r]),(0,e.jsx)(s._z,{header:{extra:[]},children:(0,e.jsx)(me.A,{submitter:{render:function(a,n){return(0,e.jsxs)(Se.S,{children:[(0,e.jsx)(le.ZP,{onClick:function(){var l;(l=a.form)===null||l===void 0||l.setFieldValue("deployBackground",!0),a.submit()},children:"\u540E\u53F0\u90E8\u7F72"}),(0,e.jsx)("span",{children:n[1]},"submit")]})}},formRef:v,onFinishFailed:function(a){Be(!1)},onFinish:function(){var i=R()(y()().mark(function a(n){var d,l,u,p;return y()().wrap(function(f){for(;;)switch(f.prev=f.next){case 0:return u={type:n.type,name:n.name,title:n.title,environment:n.environment,remoteUrl:n.remoteUrl,yaml:n.yaml,yamlOverride:n.yamlOverride,deployBackground:(d=n.deployBackground)!==null&&d!==void 0?d:!1},X&&(u.id=X),f.next=4,(0,D.im)(u);case 4:return p=f.sent,(l=v.current)===null||l===void 0||l.resetFields(),n.deployBackground&&new Promise(function(){var oe=R()(y()().mark(function C(De,tr){var q,Te,de;return y()().wrap(function(m){for(;;)switch(m.prev=m.next){case 0:m.prev=0,q=x()(Ee.map(function(_){return _.image})),m.prev=2,q.s();case 4:if((Te=q.n()).done){m.next=11;break}if(de=Te.value,!de){m.next=9;break}return m.next=9,(0,N.Gb)({tag:de,type:"pull"});case 9:m.next=4;break;case 11:m.next=16;break;case 13:m.prev=13,m.t0=m.catch(2),q.e(m.t0);case 16:return m.prev=16,q.f(),m.finish(16);case 19:m.next=24;break;case 21:m.prev=21,m.t1=m.catch(0),tr(m.t1);case 24:return m.prev=24,m.next=27,(0,D.Oh)({id:p.data.id,pullImageUseDPanel:!0,environment:n.environment,deployServiceName:[],createPath:!0,removeOrphans:!0}).finally(function(){var _;!((_=$e.current)===null||_===void 0)&&_.reloadAndRest&&$e.current.reloadAndRest()});case 27:return m.finish(24);case 28:De(!0);case 29:case"end":return m.stop()}},C,null,[[0,21,24,28],[2,13,16,19]])}));return function(C,De){return oe.apply(this,arguments)}}()),Ce("/compose/list/"),f.abrupt("return",!0);case 9:case"end":return f.stop()}},a)}));return function(a){return i.apply(this,arguments)}}(),children:(0,e.jsx)(A.Z,{split:"vertical",children:(0,e.jsxs)(ie.Z,{onResize:function(){},children:[(0,e.jsx)(ie.Z.Panel,{resizable:!1,size:Ze?"0%":"45%",children:(0,e.jsxs)(A.Z,{split:"horizontal",children:[(0,e.jsxs)(A.Z,{title:(0,e.jsx)(H.Z,{}),subTitle:"\u57FA\u7840\u4FE1\u606F",children:[(0,e.jsx)(Ue.Z,{label:"\u540E\u53F0\u90E8\u7F72",name:"deployBackground",hidden:!0}),(0,e.jsx)(T.Z,{label:"\u540D\u79F0",name:"title",disabled:(r==null?void 0:r.detail.setting.type)=="outPath",fieldProps:{onChange:function(a){var n="";if(a.target.value&&!(r!=null&&r.detail)){var d,l=(0,Le.N9)(a.target.value.trim(),{toneType:"none",type:"array"});n=l.join(""),(d=v.current)===null||d===void 0||d.setFieldValue("name",n)}}}}),(0,e.jsx)(T.Z,{label:"\u6807\u8BC6",name:"name",required:!0,rules:[{required:!0}],disabled:!!(r!=null&&r.detail),placeholder:"\u6807\u8BC6Compose\u521B\u5EFA\u7684\u5BB9\u5668\u7EC4\uFF0C\u53EA\u5141\u8BB8\u4E3A\u82F1\u6587\u6216\u662F\u6570\u5B57"}),(0,e.jsx)(Ie.Z.Group,{label:"Yaml \u6765\u6E90",name:"type",initialValue:"text",fieldProps:{defaultValue:"text",onChange:function(){}},options:[{label:"yaml",value:"text",disabled:(r==null?void 0:r.detail)&&(r==null?void 0:r.detail.setting.type)!="text"},{label:"\u8FDC\u7A0B\u5730\u5740",value:"remoteUrl",disabled:(r==null?void 0:r.detail)&&(r==null||(k=r.detail)===null||k===void 0?void 0:k.setting.type)!="remoteUrl"},{label:"\u81EA\u52A8\u53D1\u73B0",value:"storagePath",disabled:(r==null?void 0:r.detail)&&(r==null||(U=r.detail)===null||U===void 0?void 0:U.setting.type)!="storagePath"},{label:"\u5E94\u7528\u5546\u5E97",value:"store",disabled:(r==null?void 0:r.detail)&&(r==null||(Q=r.detail)===null||Q===void 0?void 0:Q.setting.type)!="store"},{label:"\u5916\u90E8\u4EFB\u52A1",value:"outPath",disabled:(r==null?void 0:r.detail)&&(r==null||(V=r.detail)===null||V===void 0?void 0:V.setting.type)!="outPath"}]}),(0,e.jsx)(ce.Z,{name:["type"],children:function(a){var n=a.type;if(n=="text")return[(0,e.jsx)(ue.Z,{title:"\u5BFC\u5165\u672C\u5730 compose \u6587\u4EF6",onImport:function(l){var u;return W(o()(o()({},P),{yaml:l})),(u=v.current)===null||u===void 0||u.setFieldValue("yaml",l),!0},onLoad:function(l){if(l.indexOf("services:")<0)throw new Error("\u5BFC\u5165\u7684compose\u6587\u4EF6\u9519\u8BEF");return!0}},"importFile"),(0,e.jsx)(Fe,{title:"\u5BFC\u5165\u8FDC\u7A0B compose \u6587\u4EF6",onFinish:function(){var d=R()(y()().mark(function l(u){var p;return y()().wrap(function(f){for(;;)switch(f.prev=f.next){case 0:return W(o()(o()({},P),{yaml:u})),(p=v.current)===null||p===void 0||p.setFieldValue("yaml",u),f.abrupt("return",!0);case 3:case"end":return f.stop()}},l)}));return function(l){return d.apply(this,arguments)}}()},"importRemote")];if(n=="remoteUrl")return[(0,e.jsx)(Fe,{title:"\u914D\u7F6E\u8FDC\u7A0B compose \u6587\u4EF6",onFinish:function(){var d=R()(y()().mark(function l(u,p){var h,f;return y()().wrap(function(C){for(;;)switch(C.prev=C.next){case 0:return W(o()(o()({},P),{yaml:u})),(h=v.current)===null||h===void 0||h.setFieldValue("yaml",u),(f=v.current)===null||f===void 0||f.setFieldValue("remoteUrl",p),C.abrupt("return",!0);case 4:case"end":return C.stop()}},l)}));return function(l,u){return d.apply(this,arguments)}}()},"importRemote1"),(0,e.jsx)(ve.Z,{name:"remoteUrl"},"remoteUrl")];if(n=="storagePath")return(0,e.jsx)(e.Fragment,{children:(0,e.jsx)(T.Z,{name:"storagePath",required:!0,readonly:!0,initialValue:r!=null&&r.detail?"".concat(r==null?void 0:r.detail.setting.uri[0]):"\u6302\u8F7D /dpanel/compose \u76EE\u5F55\u540E\uFF0C\u81EA\u52A8\u53D1\u73B0\u3002",rules:[{required:!0,message:"\u6302\u8F7D /dpanel/compose \u76EE\u5F55\u540E\uFF0C\u81EA\u52A8\u53D1\u73B0\u3002"}]})});if(n=="store")return(0,e.jsx)(e.Fragment,{children:(0,e.jsx)(T.Z,{readonly:!0,name:"store",required:!0,initialValue:r!=null&&r.detail?"".concat(r==null?void 0:r.detail.setting.store):"\u8BF7\u5148\u6DFB\u52A0\u5E94\u7528\u5546\u5E97\u540E\uFF0C\u5728\u5E94\u7528\u5546\u5E97\u91CC\u5B8C\u6210\u5B89\u88C5",rules:[{required:!0,message:"\u8BF7\u5148\u6DFB\u52A0\u5E94\u7528\u5546\u5E97\u540E\uFF0C\u5728\u5E94\u7528\u5546\u5E97\u91CC\u5B8C\u6210\u5B89\u88C5"}]})});if(n=="outPath")return(0,e.jsx)(e.Fragment,{children:(0,e.jsx)(T.Z,{name:"outPath",required:!0,readonly:!0,initialValue:(r==null?void 0:r.detail)&&"".concat(r==null?void 0:r.detail.setting.uri[0]),rules:[{required:!0,message:"\u5916\u90E8\u4EFB\u52A1\u53EA\u53EF\u7F16\u8F91 yaml "}]})})}})]}),(0,e.jsx)(A.Z,{title:(0,e.jsx)(c.Z,{}),subTitle:"\u670D\u52A1\u5217\u8868",children:(0,e.jsx)(Ae.Z,{dataSource:Ee,rowKey:"name",pagination:!1,columns:[{title:"\u540D\u79F0",dataIndex:"name"},{title:"\u955C\u50CF",dataIndex:"image"},{title:"\u7AEF\u53E3",dataIndex:"ports",render:function(a,n,d){return n.ports&&n.ports.map(function(l,u){return(0,e.jsx)(ge.Z,{size:"large",wrap:!0,children:(0,e.jsxs)(Ve.Z,{color:"#2db7f5",icon:l.published?(0,e.jsx)(g.Z,{}):"",style:{marginBottom:5},children:[l.published," : ",l.target]})},"space".concat(u))})}},{title:"\u4F9D\u8D56",dataIndex:"dependsOn",width:150,render:function(a,n,d){if(n.depends_on)return(0,e.jsx)(ge.Z,{wrap:!0,children:Object.keys(n.depends_on).map(function(l){var u=l;return n.external_links&&n.external_links.map(function(p){p.indexOf(":"+l)>-1&&(u=p)}),u})})}}]})}),(0,e.jsxs)(A.Z,{title:(0,e.jsx)(B.Z,{}),subTitle:"\u73AF\u5883\u53D8\u91CF",children:[(0,e.jsx)(ce.Z,{name:["environment"],children:function(a){var n=a.environment;if(!n||n.length==0)return(0,e.jsx)(ye.Z,{message:(0,e.jsxs)(e.Fragment,{children:["\u5728 compose.yaml \u4E2D\u58F0\u660E\u73AF\u5883\u53D8\u91CF\uFF0C\u4F8B\u5982\uFF1A","${DB_NAME}"," ",(0,e.jsx)("br",{}),"\u5728\u90E8\u7F72\u65F6\u53EF\u6839\u636E\u60C5\u51B5\u8FDB\u884C\u91CD\u65B0\u8D4B\u503C\u3002"]})})}}),(0,e.jsx)(Y.Z,{name:"environment",showDisableName:!0,showInDrawer:!0,showCardGhost:!0,showImportButton:!0,showCodeMode:!0,ref:He})]})]})}),(0,e.jsx)(ie.Z.Panel,{children:(0,e.jsxs)(A.Z,{children:[(0,e.jsx)(ve.Z,{name:"yamlOverride",hidden:!0}),(0,e.jsx)(T.Z,{name:"yaml",hidden:!0}),(0,e.jsx)(Me.Z,{tabBarExtraContent:(0,e.jsx)(le.ZP,{type:"link",onClick:function(){Be(!Ze)},children:"\u5168\u5C4F"}),items:[{label:"Yaml \u6587\u4EF6",key:"yaml",children:(0,e.jsx)(e.Fragment,{children:(0,e.jsx)(fe.ZP,{theme:"dark",minHeight:"550px",onChange:function(a){se(o()(o()({},P),{yaml:a}))},onFocus:function(){var a;((a=v.current)===null||a===void 0?void 0:a.getFieldValue("type"))=="remoteUrl"&&je.info("\u8FDC\u7A0B\u5730\u5740\u4E0D\u80FD\u76F4\u63A5\u4FEE\u6539\uFF0C\u8BF7\u65B0\u589E\u8986\u76D6 yaml \u6587\u4EF6")},onBlur:function(){var a;(a=v.current)===null||a===void 0||a.setFieldValue("yaml",P.yaml),W(P)},readOnly:((J=v.current)===null||J===void 0?void 0:J.getFieldValue("type"))=="remoteUrl",value:(M=v.current)===null||M===void 0?void 0:M.getFieldValue("yaml"),extensions:[pe.RI.yaml()]})})},{label:"\u8986\u76D6 Yaml \u6587\u4EF6",key:"yamlOverride",children:(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(ye.Z,{style:{marginBottom:20},message:(0,e.jsxs)(e.Fragment,{children:["\u8986\u76D6\u6587\u4EF6\uFF0C\u5141\u8BB8\u4F60\u5728\u4E0D\u6539\u52A8\u539F\u59CB Yaml \u6587\u4EF6\u7684\u60C5\u51B5\u4E0B\uFF0C\u8986\u76D6\u539F\u59CB\u6587\u4EF6\u4E2D\u7684\u4E00\u4E9B\u53C2\u6570\u914D\u7F6E\u3002",(0,e.jsx)("a",{href:"https://dpanel.cc/#/zh-cn/manual/compose/override",target:"_blank",children:"\u5982\u4F55\u914D\u7F6E\uFF1F"})]})}),(0,e.jsx)(fe.ZP,{theme:"dark",minHeight:"550px",onChange:function(a,n){se(o()(o()({},P),{yamlOverride:a}))},value:(L=v.current)===null||L===void 0?void 0:L.getFieldValue("yamlOverride"),extensions:[pe.RI.yaml()],onBlur:function(){var a;(a=v.current)===null||a===void 0||a.setFieldValue("yamlOverride",P.yamlOverride),W(P)}})]})}]})]})})]})})},"create")})}},3393:function(ne,O,t){t.d(O,{Gb:function(){return y},Pn:function(){return Z},Rb:function(){return ue},YU:function(){return ee},ZQ:function(){return re},_U:function(){return R},cd:function(){return D}});var b=t(15009),o=t.n(b),ae=t(99289),x=t.n(ae),E=t(82346);function ee(c){return w.apply(this,arguments)}function w(){return w=x()(o()().mark(function c(g){return o()().wrap(function(s){for(;;)switch(s.prev=s.next){case 0:return s.abrupt("return",(0,E.request)("/api/app/image/get-detail",{method:"POST",data:g}));case 1:case"end":return s.stop()}},c)})),w.apply(this,arguments)}function y(c){return z.apply(this,arguments)}function z(){return z=x()(o()().mark(function c(g){return o()().wrap(function(s){for(;;)switch(s.prev=s.next){case 0:return s.abrupt("return",(0,E.request)("/api/app/image/tag-remote",{method:"POST",data:g}));case 1:case"end":return s.stop()}},c)})),z.apply(this,arguments)}function R(c){return G.apply(this,arguments)}function G(){return G=x()(o()().mark(function c(g){return o()().wrap(function(s){for(;;)switch(s.prev=s.next){case 0:return s.abrupt("return",(0,E.request)("/api/app/image/tag-add",{method:"POST",data:g}));case 1:case"end":return s.stop()}},c)})),G.apply(this,arguments)}function Z(c){return Y.apply(this,arguments)}function Y(){return Y=x()(o()().mark(function c(g){return o()().wrap(function(s){for(;;)switch(s.prev=s.next){case 0:return s.abrupt("return",(0,E.request)("/api/app/image/tag-delete",{method:"POST",data:g}));case 1:case"end":return s.stop()}},c)})),Y.apply(this,arguments)}function ue(c){return K.apply(this,arguments)}function K(){return K=x()(o()().mark(function c(g){return o()().wrap(function(s){for(;;)switch(s.prev=s.next){case 0:return s.abrupt("return",(0,E.request)("/api/app/image/export",{method:"POST",data:g,responseType:"blob"}));case 1:case"end":return s.stop()}},c)})),K.apply(this,arguments)}function D(c){return N.apply(this,arguments)}function N(){return N=x()(o()().mark(function c(g){return o()().wrap(function(s){for(;;)switch(s.prev=s.next){case 0:return s.abrupt("return",(0,E.request)("/api/pro/image/get-remote-tag",{method:"POST",data:g}));case 1:case"end":return s.stop()}},c)})),N.apply(this,arguments)}function re(c){return H.apply(this,arguments)}function H(){return H=x()(o()().mark(function c(g){return o()().wrap(function(s){for(;;)switch(s.prev=s.next){case 0:return s.abrupt("return",(0,E.request)("/api/app/image/check-upgrade",{method:"POST",data:g}));case 1:case"end":return s.stop()}},c)})),H.apply(this,arguments)}}}]);
